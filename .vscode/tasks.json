{
    // See https://go.microsoft.com/fwlink/?LinkId=733558
    // for the documentation about the tasks.json format
    "version": "2.0.0",
    "tasks": [
        {
            "label": "Export UID:GID to $USERID",
            "type": "shell",
            "command": "echo 'export USERID=$(id -u):$(id -g)' > ~/.userid.sh",
            "isBackground": true,
            "problemMatcher": [],
            "detail": "Exports the current user's user and group IDs so that the output files are owned by the correct user",
            "presentation": {
                "echo": false,
                "reveal": "never",
                "focus": false,
                "panel": "shared",
                "showReuseMessage": false,
                "clear": false
            }
        },
        {
            "label": "Run Autoreduce container",
            "detail": "Starts a daemon that contains the Autoreduce environment.",
            "type": "shell",
            "command": "source",
            "promptOnClose": true,
            "runOptions": {
                "instanceLimit": 1,
                "runOn": "folderOpen"
            },
            "args": [
                "~/.userid.sh",
                "&&",
                "docker",
                "run",
                "--rm",
                "--network=host",
                "-v",
                "${workspaceFolder}:/autoreduce-frontend",
                "-v",
                "${workspaceFolder}/../autoreduce:/autoreduce",
                "-v",
                "~/.autoreduce:/home/.autoreduce",
                "-v",
                "~/.autoreduce/dev/reduced-data:/instrument",
                "-e",
                "HOME=/home",
                "--user",
                "$USERID",
                "--name",
                "autoreduce-debugpy",
                "-it",
                "autoreduction/dev",
                "bash"
            ],
            "presentation": {
                "echo": true,
                "reveal": "always",
                "focus": false,
                "panel": "shared",
                "showReuseMessage": false,
                "group": "docker",
                "clear": false
            },
            "problemMatcher": [],
            "dependsOn": [
                "Export UID:GID to $USERID"
            ]
        },
        {
            "label": "(don't use directly) Exec runserver",
            "detail": "Used by the debugging configuration. Don't manually use or the terminal will remain hanging until you manually attach to the --listen port",
            "type": "shell",
            "isBackground": true,
            "command": "docker exec -it autoreduce-debugpy python3 -m debugpy --listen 5679 --wait-for-client /autoreduce-frontend/autoreduce_frontend/manage.py runserver",
            "group": "test",
            "presentation": {
                "echo": true,
                "reveal": "always",
                "focus": false,
                "panel": "shared",
                "showReuseMessage": true,
                "clear": false
            },
            "problemMatcher": []
        },
        {
            "label": "(don't use directly) Exec pytest django",
            "detail": "Used by the debugging configuration. Don't manually use",
            "isBackground": true,
            "type": "shell",
            "command": "docker exec -e DISPLAY=:1 -e RUNNING_VIA_PYTEST=true -e SELENIUM_REMOTE=1 -it autoreduce-debugpy python3 -m debugpy --listen 5681 --wait-for-client -m pytest -v /autoreduce-frontend/${relativeFileDirname}/${fileBasename}",
            "group": "test",
            "presentation": {
                "echo": true,
                "reveal": "always",
                "focus": false,
                "panel": "shared",
                "showReuseMessage": true,
                "clear": false
            },
            "problemMatcher": []
        },
        {
            "label": "Kill autoreduce-debugpy",
            "type": "shell",
            "command": "docker kill autoreduce-debugpy",
            "problemMatcher": [],
            "presentation": {
                "echo": true,
                "reveal": "always",
                "focus": false,
                "panel": "shared",
                "showReuseMessage": true,
                "clear": false
            }
        },
        {
            "label": "Migrate all",
            "detail": "Migrates credentials and database (with PR fixtures)",
            "type": "shell",
            "problemMatcher": [],
            "dependsOn": [
                "Migrate credentials",
                "Migrate database (with PR fixtures)"
            ],
            "dependsOrder": "sequence",
            "group": {
                "kind": "build",
                "isDefault": true
            }
        },
        {
            "label": "Migrate credentials",
            "type": "shell",
            "command": "docker exec -it autoreduce-debugpy autoreduce-creds-migrate",
            "problemMatcher": [],
            "group": "build"
        },
        {
            "label": "Migrate database (with PR fixtures)",
            "type": "shell",
            "command": "docker exec -it autoreduce-debugpy bash -c 'python3 /autoreduce-frontend/autoreduce_frontend/manage.py migrate && python3 /autoreduce-frontend/autoreduce_frontend/manage.py loaddata super_user_fixture status_fixture pr_test'",
            "problemMatcher": [],
            "group": "build"
        },
        {
            "label": "Migrate database (clean)",
            "type": "shell",
            "command": "docker exec -it autoreduce-debugpy python3 /autoreduce-frontend/autoreduce_frontend/manage.py migrate",
            "isBackground": true,
            "problemMatcher": [],
            "group": "build"
        },
        {
            "label": "Run Selenium Docker daemon",
            "type": "shell",
            "command": "docker run --name selenium --rm -it -p 4444:4444 -v /dev/shm:/dev/shm selenium/standalone-chrome:4.0.0-beta-3-prerelease-20210422",
            "problemMatcher": []
        }
    ]
}